<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>í‚¤ì›€í˜•ëŒ€ìš© ì‹ ìš©ì£¼ë¬¸ & ë‹´ë³´ë¹„ìœ¨ ê³„ì‚°ê¸°</title>
<style>
  :root{
    --card:#fafafa; --line:#e6e6e6; --muted:#777; --ok:#127c36; --warn:#b00020;
    --req-bg:#fff7d1; --req-bd:#f2c94c;
  }
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',Arial;line-height:1.9;margin:0;background:#fff}
  .wrap{max-width:980px;margin:0 auto;padding:20px}
  h1,h2,h3{margin:1.2em 0 .5em}
  .card{border:1px solid var(--line);border-radius:12px;padding:14px;margin:10px 0;background:var(--card)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  label{font-weight:600;font-size:14px}
  input[type="text"], select{width:100%;padding:10px 12px;border:1px solid #cfcfcf;border-radius:10px;background:#fff;font-size:15px}
  input[readonly]{background:#f1f8f4}
  small{color:#666}
  .muted{color:var(--muted);font-size:14px}
  .btn{display:inline-block;padding:9px 14px;border:1px solid #999;border-radius:10px;background:#fff;cursor:pointer}
  .btn.primary{background:#111;color:#fff;border-color:#111}
  .btn-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#fff}
  th,td{padding:10px 8px;border-bottom:1px solid #eee;text-align:center;font-size:14px}
  th{background:#f6f6f6;font-weight:700}
  tr:last-child td{border-bottom:none}
  .pill{display:inline-block;padding:2px 10px;border-radius:999px;border:1px solid #ddd;background:#f8f8f8;font-size:12px}
  .tag{font-weight:700}
  .ok{color:var(--ok)} .warn{color:var(--warn)}
  .legend{display:flex;gap:10px;align-items:center;margin:.5rem 0 0}
  .legend .chip{display:inline-block;padding:2px 10px;border-radius:999px;border:1px solid #ddd;background:#f8f8f8;font-size:12px}
  .req{background:var(--req-bg) !important;border-color:var(--req-bd) !important; box-shadow:0 0 0 2px rgba(242,201,76,.15) inset}
  .req-label::after{content:"  (í•„ìˆ˜)"; color:#b46900; font-weight:700}
  details{background:#fbfbfb;border:1px dashed #ddd;border-radius:10px;padding:10px 12px}
  @media (max-width:720px){.row,.row-3{grid-template-columns:1fr} table{font-size:13px}}
</style>
</head>
<body>
<div class="wrap" id="kiwoom-calc">
  <h1>í‚¤ì›€í˜•ëŒ€ìš© 45% ê·œì¹™: ì‹ ìš©ì£¼ë¬¸ ìµœëŒ€ì¹˜ & ë‹´ë³´ë¹„ìœ¨ 140% ë§ì¶”ê¸°</h1>
  <p class="muted">â€¢ <b>ë³´ì¦ê¸ˆë¥  45%</b>ëŠ” <b>í˜„ê¸ˆ 30% + ëŒ€ìš© 15%</b> êµ¬ì„± â‡’ <span class="pill">ëŒ€ìš© ì¸ì • ìƒí•œ = í˜„ê¸ˆ Ã— 0.5</span><br>
  â€¢ <b>ì‹ ìš©ì£¼ë¬¸ ê°€ëŠ¥ê¸ˆì•¡</b> = (í˜„ê¸ˆ + ì¸ì •ëŒ€ìš©) Ã· 0.45 Â· <b>ë‹´ë³´ë¹„ìœ¨</b> = (ë‹´ë³´ê³„ Ã· ì‹ ìš©ê³„) Ã— 100 â†’ <span class="tag">140% ì´ìƒ</span></p>

  <!-- â‘  ê¸°ë³¸ ì…ë ¥ -->
  <div class="card">
    <h3>â‘  ê¸°ë³¸ ì…ë ¥</h3>
    <div class="legend">
      <span class="chip">ğŸ’¡ ìˆ«ì ì…ë ¥ì¹¸ì€ ìë™ìœ¼ë¡œ <b>ì²œë‹¨ìœ„(,)</b> í‘œì‹œë©ë‹ˆë‹¤.</span>
      <span class="chip">ğŸŸ¡ ë…¸ë€ ì¹¸ì€ <b>í•„ìˆ˜</b> ì…ë ¥</span>
    </div>
    <div class="row">
      <div>
        <label class="req-label">í˜„ê¸ˆ(ì˜ˆìˆ˜ê¸ˆ, ì›)</label>
        <input type="text" id="cash" class="num req" value="1,000,000" inputmode="numeric" placeholder="ì˜ˆ: 1,000,000">
      </div>
      <div>
        <label class="req-label">ëŒ€ìš©(ì¦ê¶Œ) í‰ê°€ê¸ˆì•¡(ì›)</label>
        <input type="text" id="substit" class="num req" value="1,000,000" inputmode="numeric" placeholder="ì˜ˆ: 1,000,000">
      </div>
    </div>
    <div class="row-3" style="margin-top:8px">
      <div>
        <label>ë³´ì¦ê¸ˆë¥ (%)</label>
        <input type="text" id="marginRate" value="45" inputmode="decimal">
        <small>í‚¤ì›€í˜•ëŒ€ìš© ê¸°ë³¸ 45%</small>
      </div>
      <div>
        <label>ë³´ì¦ê¸ˆ êµ¬ì„±ë¹„ - í˜„ê¸ˆ(%)</label>
        <input type="text" id="cashRate" value="30" inputmode="decimal">
        <small>ê¸°ë³¸ 30%</small>
      </div>
      <div>
        <label>ë³´ì¦ê¸ˆ êµ¬ì„±ë¹„ - ëŒ€ìš©(%)</label>
        <input type="text" id="substitRate" value="15" inputmode="decimal">
        <small>ê¸°ë³¸ 15% (í˜„ê¸ˆì˜ ì ˆë°˜)</small>
      </div>
    </div>
  </div>

  <!-- â‘¡ ì‹ ìš©ê³„Â·ëª©í‘œë¹„ìœ¨ -->
  <div class="card">
    <h3>â‘¡ ì‹ ìš©ê³„Â·ëª©í‘œë¹„ìœ¨</h3>
    <div class="row">
      <div>
        <label class="req-label">ì‹ ìš©ê³„(ì›) = ì‹ ìš©ìœµì + ëŒ€ì£¼ + ë‹´ë³´ëŒ€ì¶œ(ì²´ê²°ê¸°ì¤€)</label>
        <input type="text" id="creditTotal" class="num req" value="0" inputmode="numeric" placeholder="ì˜ˆ: 12,345,678">
      </div>
      <div>
        <label>ëª©í‘œ ë‹´ë³´ìœ ì§€ë¹„ìœ¨(%)</label>
        <input type="text" id="targetRatio" value="140" inputmode="decimal">
        <small>ê¸°ë³¸ 140%</small>
      </div>
    </div>
  </div>

  <!-- â‘¢ ë‹´ë³´ë“±ê¸‰í‘œ -->
  <div class="card">
    <h3>â‘¢ ë‹´ë³´ë“±ê¸‰í‘œ(ì¸ì •ë¹„ìœ¨, %)</h3>
    <div class="row-3">
      <div><label>A</label><input type="text" id="gradeA" value="70" inputmode="decimal"></div>
      <div><label>B</label><input type="text" id="gradeB" value="65" inputmode="decimal"></div>
      <div><label>C</label><input type="text" id="gradeC" value="60" inputmode="decimal"></div>
      <div><label>D</label><input type="text" id="gradeD" value="55" inputmode="decimal"></div>
      <div><label>E</label><input type="text" id="gradeE" value="50" inputmode="decimal"></div>
    </div>
    <small class="muted">â€» ì¢…ëª©Â·ì‹œì ì— ë”°ë¼ ë³€ë™. ìµœì‹  ê³µì§€ë¡œ ì¡°ì •í•˜ì„¸ìš”.</small>
  </div>

  <!-- â‘£ ë‹´ë³´ ì¢…ëª© ì…ë ¥ -->
  <div class="card">
    <h3>â‘£ ë‹´ë³´ ì¢…ëª© ì…ë ¥(ë‹´ë³´ë¹„ìœ¨ ê³„ì‚°ìš©)</h3>
    <table id="tbl">
      <thead><tr><th>ì¢…ëª©ëª…</th><th>í‰ê°€ê¸ˆì•¡(ì›)</th><th>ë‹´ë³´ë“±ê¸‰</th><th>ì¸ì •ë¹„ìœ¨</th><th>ìœ íš¨ë‹´ë³´ê¸ˆ</th></tr></thead>
      <tbody id="tbody"></tbody>
      <tfoot><tr><th colspan="4" style="text-align:right">ìœ íš¨ë‹´ë³´ í•©ê³„</th><th id="sumEff">0</th></tr></tfoot>
    </table>
    <div class="btn-row"><button class="btn" id="addRowBtn">í–‰ ì¶”ê°€</button><button class="btn" id="clearRowsBtn">ëª¨ë‘ ì‚­ì œ</button></div>
  </div>

  <!-- â‘¤ ê²°ê³¼ -->
  <div class="card">
    <h3>â‘¤ ê²°ê³¼</h3>
    <div class="row">
      <div>
        <label>ì¸ì • ëŒ€ìš©(ì£¼ë¬¸ìš©, ì›)</label>
        <input type="text" id="recognizedSubstit" readonly>
        <small>MIN(ëŒ€ìš©, í˜„ê¸ˆ Ã— (ëŒ€ìš©%/í˜„ê¸ˆ%))</small>
      </div>
      <div>
        <label>ì‹ ìš©ì£¼ë¬¸ ê°€ëŠ¥ê¸ˆì•¡(ì›)</label>
        <input type="text" id="orderCapacity" readonly>
        <small>(í˜„ê¸ˆ + ì¸ì •ëŒ€ìš©) Ã· ë³´ì¦ê¸ˆë¥ </small>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div>
        <label>ë‹´ë³´ê³„(ì›) = í˜„ê¸ˆ + ìœ íš¨ë‹´ë³´ í•©ê³„</label>
        <input type="text" id="collateralSum" readonly>
      </div>
      <div>
        <label>ë‹´ë³´ë¹„ìœ¨(%)</label>
        <input type="text" id="collateralRatio" readonly>
        <small id="ratioStatus" class="ok">140% ì´ìƒì´ë©´ ì •ìƒ</small>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div>
        <label>í•„ìš” ì¶”ê°€ë‹´ë³´ê¸ˆ(ì›)</label>
        <input type="text" id="requiredCollateral" readonly>
      </div>
      <div style="display:flex;align-items:center;gap:10px"><span class="pill">ì²´ê²°ê¸°ì¤€ Â· 16:30 ì´í›„ í˜„ì¬ê°€ ì ìš©</span></div>
    </div>
    <div class="btn-row"><button class="btn primary" id="recalcBtn">ê³„ì‚°í•˜ê¸°</button><button class="btn" id="resetBtn">ì´ˆê¸°í™”</button></div>
  </div>

  <!-- â‘¥ ë‹¨ìˆœ ë¬´ì‹ë²• -->
  <div class="card">
    <h3>â‘¥ â€˜ë‹¨ìˆœ ë¬´ì‹ë²•â€™(ì¼ë¶€ ìƒí™˜Â·ë§¤ë„) ë¹ ë¥¸ ì¶”ì •</h3>
    <div class="row">
      <div>
        <label>í˜„ì¬ ë‹´ë³´ë¶€ì¡±ì•¡(ì›)</label>
        <input type="text" id="brutalShortfall" class="num" value="1,000,000">
      </div>
      <div>
        <label>1ì£¼ ë§¤ë„ ì‹œ ë¶€ì¡±ì•¡ ê°ì†Œ(ì›)</label>
        <input type="text" id="perShareEffect" class="num" value="100,000">
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <div>
        <label>í•„ìš” ë§¤ë„ ìˆ˜ëŸ‰(ì¶”ì •, ì£¼)</label>
        <input type="text" id="neededShares" readonly>
      </div>
      <div class="muted">â€» ì²´ê°ì¹˜ ê¸°ë°˜ ì¶”ì •ì¹˜ì…ë‹ˆë‹¤. (ìˆ˜ìˆ˜ë£Œ/í˜¸ê°€Â·ìŠ¬ë¦¬í”¼ì§€ ê°ì•ˆí•˜ì—¬ 1~2íšŒ ë¯¸ì„¸ì¡°ì • ê¶Œì¥)</div>
    </div>
    <div class="btn-row"><button class="btn" id="calcBrutalBtn">ë¹ ë¥´ê²Œ ì¶”ì •</button></div>
  </div>

  <!-- â‘¦ S ì¼ë°˜ì‹ ê³„ì‚°ê¸° -->
  <div class="card">
    <h3>â‘¦ ëª©í‘œ 140% ìœ„í•œ í•„ìš” ë§¤ë„ê¸ˆì•¡ S (ë“±ê¸‰ k ë°˜ì˜)</h3>
    <div class="row">
      <div>
        <label class="req-label">í˜„ì¬ ë‹´ë³´ê³„ C (ì›)</label>
        <input type="text" id="S_C" class="num req" value="0" inputmode="numeric" placeholder="ì˜ˆ: ë‹´ë³´ê³„ í•©ê³„">
      </div>
      <div>
        <label class="req-label">í˜„ì¬ ì‹ ìš©ê³„ L (ì›)</label>
        <input type="text" id="S_L" class="num req" value="0" inputmode="numeric" placeholder="ì˜ˆ: ìœµì/ëŒ€ì£¼/ë‹´ë³´ëŒ€ì¶œ í•©ê³„">
      </div>
    </div>
    <div class="row-3" style="margin-top:8px">
      <div>
        <label>ë§¤ë„ ëŒ€ìƒ ë‹´ë³´ë“±ê¸‰</label>
        <select id="S_grade"><option>A</option><option>B</option><option>C</option><option>D</option><option>E</option></select>
        <small>ë“±ê¸‰í‘œì˜ ì¸ì •ë¹„ìœ¨ ì‚¬ìš©</small>
      </div>
      <div>
        <label>ìƒí™© ì„ íƒ</label>
        <select id="S_case">
          <option value="A">A/C: ë§¤ë„ ì¦‰ì‹œ ìƒí™˜</option>
          <option value="B">B: í˜„ê¸ˆ ë³´ìœ (ìƒí™˜ ì•ˆ í•¨)</option>
        </select>
        <small>A/Cê°€ ì¼ë°˜ì ìœ¼ë¡œ ë” íš¨ìœ¨ì </small>
      </div>
      <div>
        <label>í•„ìš” ë§¤ë„ê¸ˆì•¡ S (ì›)</label>
        <input type="text" id="S_result" readonly>
      </div>
    </div>
    <div class="btn-row"><button class="btn" id="calcSBtn">S ê³„ì‚°</button></div>
  </div>

  <!-- ì‚¬ìš© ì„¤ëª… (ìƒì„¸) -->
  <details style="margin-top:12px" open>
    <summary><b>ì‚¬ìš© ì„¤ëª…(ìƒì„¸) & ì£¼ì˜ì‚¬í•­</b></summary>
    <ol>
      <li><b>ê¸°ë³¸ ì…ë ¥</b>ì— ì˜ˆìˆ˜ê¸ˆ(í˜„ê¸ˆ)ê³¼ ëŒ€ìš©í‰ê°€ê¸ˆì•¡ì„ ë„£ìŠµë‹ˆë‹¤. ë…¸ë€ ì¹¸ë¶€í„° ì±„ìš°ë©´ ìµœì†Œ ì •ë³´ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.</li>
      <li><b>ë³´ì¦ê¸ˆë¥ /í˜„ê¸ˆÂ·ëŒ€ìš© ë¹„ìœ¨</b>ì€ ê¸°ë³¸ê°’(45/30/15)ì„ ì‚¬ìš©í•˜ë˜, ê³„ì¢Œ ìœ í˜•ì´ ë‹¤ë¥´ë©´ ìˆ˜ì •í•˜ì„¸ìš”.</li>
      <li><b>ë‹´ë³´ ì¢…ëª©</b>ì—ëŠ” ë³´ìœ  ì¢…ëª©ì˜ í‰ê°€ê¸ˆì•¡Â·ë‹´ë³´ë“±ê¸‰ì„ ì¶”ê°€í•©ë‹ˆë‹¤(í–‰ ì¶”ê°€). ì¸ì •ë¹„ìœ¨ì€ A~E ì…ë ¥ì¹¸ì„ ë°”ê¾¸ë©´ ìë™ ë°˜ì˜ë©ë‹ˆë‹¤.</li>
      <li><b>ê³„ì‚°í•˜ê¸°</b> ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ â€˜ì‹ ìš©ì£¼ë¬¸ ê°€ëŠ¥ê¸ˆì•¡â€™, â€˜ë‹´ë³´ë¹„ìœ¨â€™, â€˜í•„ìš” ì¶”ê°€ë‹´ë³´ê¸ˆâ€™ì´ ì¦‰ì‹œ ê°±ì‹ ë©ë‹ˆë‹¤.</li>
      <li><b>S ê³„ì‚°ê¸°</b>: ë‹´ë³´ê³„(C)Â·ì‹ ìš©ê³„(L)ë¥¼ ì…ë ¥í•˜ê³ , ë§¤ë„ëŒ€ìƒ ë“±ê¸‰(k)ê³¼ ìƒí™©(A/C ë˜ëŠ” B)ì„ ê³ ë¥¸ ë’¤ <b>S ê³„ì‚°</b>ì„ ëˆ„ë¥´ë©´ ëª©í‘œ 140%ì— í•„ìš”í•œ ë§¤ë„ê¸ˆì•¡ì„ ì‚°ì¶œí•©ë‹ˆë‹¤.<br>
          - A/C(ë§¤ë„ ì¦‰ì‹œ ìƒí™˜): <code>S â‰¥ (1.4L âˆ’ C) / (1.4 âˆ’ k)</code><br>
          - B(í˜„ê¸ˆ ë³´ìœ ): <code>S â‰¥ (1.4L âˆ’ C) / (1 âˆ’ k)</code></li>
      <li><b>ë‹¨ìˆœ ë¬´ì‹ë²•</b>: í˜„ì¬ ë¶€ì¡±ì•¡ê³¼ â€˜1ì£¼ ë§¤ë„ ì‹œ ë¶€ì¡±ì•¡ ê°ì†Œâ€™ë¥¼ ë„£ê³  ë¹ ë¥´ê²Œ í•„ìš”í•œ ì£¼ì‹ì„ ì¶”ì •í•©ë‹ˆë‹¤.</li>
      <li><b>ì²´ê²°ê¸°ì¤€Â·ì‹œê°</b>: ë‹´ë³´ë¹„ìœ¨ì€ Dì¼ ì²´ê²°ê¸°ì¤€, <b>16:30 ì´í›„ í˜„ì¬ê°€</b>ê°€ ìµœì¢…. ì¥ì¤‘ ë³€ë™ìœ¼ë¡œ ì¸í•œ ë¶€ì¡±/í•´ì†ŒëŠ” ë¶ˆì¸ì •(ì…ê¸ˆ/ì…ê³ ëŠ” ì¦‰ì‹œ ë°˜ì˜).</li>
      <li><b>ì‹ ê·œì£¼ë¬¸ ì œí•œ</b>: ì¥ì¤‘ ì‹¤ì‹œê°„ ë‹´ë³´ë¹„ìœ¨ <b>100% ë¯¸ë§Œ</b>ì´ë©´ ì‹ ê·œ ì£¼ë¬¸ ê¸ˆì§€.</li>
      <li><b>ê°€ì •ì‚°ì˜ˆìˆ˜ê¸ˆ</b>: 140% ë¯¸ë§Œ êµ¬ê°„ì—ì„œ <b>ê°€ì •ì‚°ì˜ˆìˆ˜ê¸ˆì´ ìŒìˆ˜</b>ë©´ ì‹ ê·œë§¤ìˆ˜ê°€ ë§‰í™ë‹ˆë‹¤. ì´ë•ŒëŠ” í˜„ê¸ˆì£¼ì‹ ì¼ë¶€ ë§¤ë„ë¡œ ë¨¼ì € <b>í”ŒëŸ¬ìŠ¤ ì „í™˜</b>í•˜ì„¸ìš”.</li>
    </ol>
    <p class="muted">â€» ë³¸ ê³„ì‚°ê¸°ëŠ” ì•ˆë‚´ ëª©ì ì´ë©° ì‹¤ì œ ì²´ê²°Â·ì •ì‚° ê·œì •ì€ ì¦ê¶Œì‚¬ ì •ì±…ì„ ë”°ë¦…ë‹ˆë‹¤. ë‹´ë³´A~E ì¸ì •ë¹„ìœ¨ì€ ìˆ˜ì‹œ ë³€ê²½ë˜ë¯€ë¡œ ìµœì‹  ê³µì§€ë¥¼ ë°˜ì˜í•˜ì„¸ìš”.</p>
  </details>
</div>

<script>
/* ---------- Helpers ---------- */
const qs = s => document.querySelector(s);
const qsa = s => Array.from(document.querySelectorAll(s));
const parseNum = v => {
  if (typeof v !== 'string') v = String(v ?? '');
  v = v.replace(/[^\d\-\.]/g,'');
  if (v === '' || v === '-' || v === '--') return 0;
  const n = Number(v);
  return isNaN(n) ? 0 : n;
};
const fmt = (n,d=0)=>{ const x = Number(n)||0; return x.toLocaleString('ko-KR',{maximumFractionDigits:d,minimumFractionDigits:d}); };
const pctToDec = p => { const n = parseNum(p); return (n > 2 ? n/100 : n); };

/* ---------- Thousand separators on inputs ---------- */
function attachNumberFormatter(el){
  // live recalc while typing
  el.addEventListener('input', ()=>{ recalc(); });
  // on focus: show raw digits for easy edit
  el.addEventListener('focus', ()=>{
    el.setSelectionRange?.(0, el.value.length);
    el.value = String(parseNum(el.value) || '');
  });
  // on blur: format with commas
  el.addEventListener('blur', ()=>{
    const n = parseNum(el.value);
    el.value = n ? n.toLocaleString('ko-KR') : '';
    recalc();
  });
}
function formatAllNumbers(){
  qsa('input.num').forEach(el=>{
    const n = parseNum(el.value);
    el.value = n ? n.toLocaleString('ko-KR') : '';
  });
}

/* ---------- Dynamic collateral rows ---------- */
const tbody = qs('#tbody');
function addRow(name='', amount='', grade='A'){
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input type="text" class="c-name" value="${name}" style="width:100%;padding:8px;border:1px solid #cfcfcf;border-radius:8px"></td>
    <td><input type="text" class="c-amt num" value="${amount}" inputmode="numeric" style="width:100%;padding:8px;border:1px solid #cfcfcf;border-radius:8px;text-align:right"></td>
    <td>
      <select class="c-grade" style="width:100%">
        <option${grade==='A'?' selected':''}>A</option>
        <option${grade==='B'?' selected':''}>B</option>
        <option${grade==='C'?' selected':''}>C</option>
        <option${grade==='D'?' selected':''}>D</option>
        <option${grade==='E'?' selected':''}>E</option>
      </select>
    </td>
    <td class="c-rate">â€”</td>
    <td class="c-eff">0</td>`;
  tbody.appendChild(tr);
  const amt = tr.querySelector('.c-amt');
  attachNumberFormatter(amt);
  tr.querySelector('.c-grade').addEventListener('change', recalc);
  formatAllNumbers();
  recalc();
}
function clearRows(){ tbody.innerHTML = ''; recalc(); }

/* ---------- Core calc ---------- */
function getGradeMap(){
  return {
    A: pctToDec(qs('#gradeA').value),
    B: pctToDec(qs('#gradeB').value),
    C: pctToDec(qs('#gradeC').value),
    D: pctToDec(qs('#gradeD').value),
    E: pctToDec(qs('#gradeE').value),
  };
}

function recalc(){
  const cash = parseNum(qs('#cash').value);
  const substit = parseNum(qs('#substit').value);
  const marginRate = pctToDec(qs('#marginRate').value);
  const cashRate = pctToDec(qs('#cashRate').value);
  const substitRate = pctToDec(qs('#substitRate').value);
  const creditTotal = parseNum(qs('#creditTotal').value);
  const targetRatio = pctToDec(qs('#targetRatio').value);

  // 1) ì¸ì • ëŒ€ìš© (ì£¼ë¬¸ìš©)
  const ratioCH = cashRate > 0 ? (substitRate / cashRate) : 0;
  const recognizedSubstit = Math.min(substit, cash * ratioCH);

  // 2) ì‹ ìš©ì£¼ë¬¸ ê°€ëŠ¥ê¸ˆì•¡
  const orderCapacity = marginRate > 0 ? (cash + recognizedSubstit) / marginRate : 0;

  // 3) ë‹´ë³´ ìœ íš¨í•©
  const gmap = getGradeMap();
  let sumEff = 0;
  qsa('#tbody tr').forEach(tr=>{
    const amt = parseNum(tr.querySelector('.c-amt').value);
    const gr = tr.querySelector('.c-grade').value || 'A';
    const rate = gmap[gr] ?? 0;
    const eff = amt * rate;
    tr.querySelector('.c-rate').textContent = (rate*100).toFixed(0) + '%';
    tr.querySelector('.c-eff').textContent = fmt(eff);
    sumEff += eff;
  });
  qs('#sumEff').textContent = fmt(sumEff);

  // 4) ë‹´ë³´ê³„
  const collateralSum = cash + sumEff;

  // 5) ë‹´ë³´ë¹„ìœ¨
  let ratioTxt = 'N/A', ratio = 0;
  if (creditTotal > 0){
    ratio = (collateralSum / creditTotal) * 100;
    ratioTxt = fmt(ratio, 2);
  }

  // 6) í•„ìš” ì¶”ê°€ë‹´ë³´
  const need = Math.max(0, creditTotal*targetRatio - collateralSum);

  // Update UI
  qs('#recognizedSubstit').value = fmt(recognizedSubstit);
  qs('#orderCapacity').value = fmt(orderCapacity);
  qs('#collateralSum').value = fmt(collateralSum);
  qs('#collateralRatio').value = ratioTxt;
  const rs = qs('#ratioStatus');
  if (creditTotal > 0){
    if (ratio >= 140){ rs.textContent='140% ì´ìƒ(ì •ìƒ)'; rs.className='ok'; }
    else { rs.textContent='140% ë¯¸ë§Œ(ì¶”ê°€ë‹´ë³´ í•„ìš”)'; rs.className='warn'; }
  } else { rs.textContent='ì‹ ìš©ê³„(ì”ì•¡) 0ì´ë©´ ë¹„ìœ¨ ì‚°ì¶œ ë¶ˆê°€'; rs.className='muted'; }
  qs('#requiredCollateral').value = fmt(need);
}

/* ---------- S ê³„ì‚° (k ë°˜ì˜) ---------- */
function calcS(){
  const L = parseNum(qs('#S_L').value);
  const C = parseNum(qs('#S_C').value);
  const gmap = getGradeMap();
  const k = gmap[qs('#S_grade').value] || 0;
  const mode = qs('#S_case').value;
  const need = 1.4*L - C;
  if (need <= 0){ qs('#S_result').value = '0'; return; }
  const denom = (mode==='A') ? (1.4 - k) : (1 - k);
  const S = denom > 0 ? need / denom : 0;
  qs('#S_result').value = fmt(Math.ceil(S));
}

/* ---------- Brutal calc ---------- */
function calcBrutal(){
  const shortfall = parseNum(qs('#brutalShortfall').value);
  const perShare = parseNum(qs('#perShareEffect').value);
  const shares = (perShare > 0) ? Math.ceil(shortfall / perShare) : 0;
  qs('#neededShares').value = fmt(shares);
}

/* ---------- Init ---------- */
function resetAll(){
  // ê¸°ë³¸ê°’ ì„¸íŒ… (í•„ìˆ˜ì¹¸ì€ ë…¸ë€ìƒ‰)
  qs('#cash').value = '1000000';
  qs('#substit').value = '1000000';
  qs('#marginRate').value = '45';
  qs('#cashRate').value = '30';
  qs('#substitRate').value = '15';
  qs('#creditTotal').value = '0';
  qs('#targetRatio').value = '140';
  qs('#gradeA').value = '70';
  qs('#gradeB').value = '65';
  qs('#gradeC').value = '60';
  qs('#gradeD').value = '55';
  qs('#gradeE').value = '50';
  qs('#brutalShortfall').value = '1000000';
  qs('#perShareEffect').value = '100000';

  clearRows();
  addRow('ì˜ˆì‹œA','500000','A');
  addRow('ì˜ˆì‹œB','300000','D');

  formatAllNumbers();
  recalc();
}

// attach formatters to all numeric inputs
qsa('input.num').forEach(attachNumberFormatter);

// buttons
document.getElementById('addRowBtn').addEventListener('click', ()=>addRow('','', 'A'));
document.getElementById('clearRowsBtn').addEventListener('click', clearRows);
document.getElementById('recalcBtn').addEventListener('click', recalc);
document.getElementById('resetBtn').addEventListener('click', resetAll);
document.getElementById('calcSBtn').addEventListener('click', calcS);
document.getElementById('calcBrutalBtn').addEventListener('click', calcBrutal);

// first paint
resetAll();
</script>
</body>
</html>
